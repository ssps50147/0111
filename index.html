<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>é˜¿é¹¿é¹¿æ–‡å‰µ-è²ªé£Ÿé¹¿(åƒé¹¿ç²‰)</title>

  <style>
    :root{
      --bg1:#ffd6e7;
      --bg2:#fff4f9;
      --card:#ffffffcc;
      --text:#111;
      --shadow: rgba(0,0,0,.12);
      --safeT: env(safe-area-inset-top);
      --safeB: env(safe-area-inset-bottom);
    }
    html,body{height:100%; margin:0;}
    body{
      font-family: system-ui,-apple-system,"Segoe UI","Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      color: var(--text);
      display:flex;
      justify-content:center;
    }
    .wrap{
      width:min(560px, 100%);
      padding: calc(12px + var(--safeT)) 12px calc(12px + var(--safeB));
      box-sizing:border-box;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius:16px;
      background: var(--card);
      box-shadow: 0 8px 20px var(--shadow);
      backdrop-filter: blur(8px);
    }
    .title{display:flex; flex-direction:column; gap:4px;}
    .title b{font-size:15px; line-height:1.1;}
    .title small{opacity:.75; line-height:1.1;}
    .pill{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}
    .btn{
      border:0;
      padding:10px 12px;
      border-radius:14px;
      background:#111;
      color:#fff;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 8px 16px rgba(0,0,0,.12);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .btn.secondary{
      background:#fff;
      color:#111;
      border:1px solid rgba(0,0,0,.12);
      box-shadow:none;
    }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.12);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }

    .row{display:flex; gap:12px; margin-top:12px; align-items:stretch; flex-wrap:wrap;}
    .panel{
      flex:1 1 250px;
      padding:12px;
      border-radius:16px;
      background: var(--card);
      box-shadow: 0 8px 20px var(--shadow);
      backdrop-filter: blur(8px);
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      align-items:center;
      font-size:13px;
    }
    .kv .v{font-weight:900;}
    .hint{font-size:12px; opacity:.75; margin-top:8px; line-height:1.45;}

    .gamebox{
      margin-top:12px;
      padding:12px;
      border-radius:20px;
      background: rgba(255,255,255,.68);
      box-shadow: 0 10px 26px rgba(0,0,0,.12);
    }
    canvas{
      width:100%;
      height:auto;
      border-radius:16px;
      background:#0b0b0f;
      touch-action:none;
      display:block;
    }
    .controls{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .pad{
      padding:12px 10px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      font-weight:900;
      text-align:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .pad:active{transform: translateY(1px);}

    .footer{
      margin-top:12px;
      font-size:12px;
      opacity:.7;
      text-align:center;
      line-height:1.45;
    }

    .toggleRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .toggle{
      display:flex; align-items:center; gap:8px;
      font-size:12px; font-weight:900;
      white-space:nowrap;
    }
    .toggle input{transform: scale(1.15);}
    .slider{
      display:flex; align-items:center; gap:8px;
      font-size:12px; font-weight:900;
      white-space:nowrap;
    }
    .slider input[type="range"]{ width:120px; }

    .namebox{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .namebox input{
      flex: 1 1 140px;
      border:1px solid rgba(0,0,0,.15);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      outline:none;
      background:#fff;
    }

    /* Modal */
    .mask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.48);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index:50;
    }
    .modal{
      width:min(560px, 100%);
      border-radius:18px;
      background:#fff;
      padding:14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    .modalHead{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .modalHeadLeft{
      display:flex; gap:12px; align-items:center;
      min-width:0;
    }
    .avatar{
      width:54px; height:54px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      object-fit:cover;
      flex: 0 0 auto;
    }
    .modal h3{margin:6px 0 8px; font-size:16px;}
    .modal p{margin:0 0 10px; font-size:13px; opacity:.88; line-height:1.55;}
    .modal .actions{
      display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;
    }
    .rank{
      margin-top:10px;
      border-top:1px dashed rgba(0,0,0,.15);
      padding-top:10px;
      font-size:13px;
    }
    .rank ol{margin:8px 0 0 0; padding:0; list-style:none;}
    .rank li{
      margin:8px 0;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px;
      border-radius:14px;
      background: rgba(0,0,0,.04);
    }
    .rankLeft{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .rankAva{
      width:36px; height:36px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      object-fit:cover;
      background:#fff;
      flex: 0 0 auto;
    }
    .rankName{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 260px;
    }
    .rankScore{font-weight:900;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">
      <b>é˜¿é¹¿é¹¿æ–‡å‰µ-è²ªé£Ÿé¹¿(åƒé¹¿ç²‰)</b>
      <small>ç©å®¶ï¼š<span id="playerName">Guest</span>ã€€ï½œã€€å€ç‡ï¼š<span id="mult">x1</span></small>
    </div>
    <div class="pill">
      <span class="tag">åˆ†æ•¸ <span id="score">0</span></span>
      <span class="tag">æœ€é«˜ <span id="best">0</span></span>
      <button class="btn secondary" id="btnRank">æŸ¥è©¢æ’è¡Œæ¦œ</button>
      <button class="btn secondary" id="btnHow">ç©æ³•</button>
      <button class="btn" id="btnStart">é–‹å§‹</button>
    </div>
  </div>

  <div class="row">
    <div class="panel">
      <div class="kv">
        <div>é€Ÿåº¦</div><div class="v" id="spd">æ­£å¸¸</div>
        <div>é€£åƒ</div><div class="v" id="streak">0</div>
        <div>ä¸‹ä¸€éš»</div><div class="v" id="nextItem">â€”</div>
        <div>èº«é«”é•·åº¦</div><div class="v" id="len">1</div>
      </div>
      <div class="hint">
        åŠ åˆ†é …ç›®æ‰ç®—é€£åƒï¼›åƒåˆ°åœ°é›·ã€Œç”Ÿæ°£é¹¿é¹¿ã€æœƒä¸­æ–·é€£åƒä¸¦é‡ç½®é€Ÿåº¦ã€‚<br/>
        è¶…é 3 ç§’æ²’åƒåˆ°åŠ åˆ†é …ç›®ï¼Œé€£åƒæœƒé–‹å§‹ç·©æ…¢ä¸‹é™ï¼ˆæ¯ tick ç´„ -0.35ï¼‰ã€‚
      </div>
    </div>

    <div class="panel">
      <div class="toggleRow">
        <div class="toggle"><label><input type="checkbox" id="bgmOn" checked> BGM</label></div>
        <div class="slider">éŸ³é‡ <input id="bgmVol" type="range" min="0" max="100" value="35"></div>
      </div>
      <div class="toggleRow" style="margin-bottom:0;">
        <div class="toggle"><label><input type="checkbox" id="sfxOn" checked> éŸ³æ•ˆ</label></div>
        <div class="slider">éŸ³é‡ <input id="sfxVol" type="range" min="0" max="100" value="55"></div>
      </div>

      <div class="namebox" style="margin-top:10px;">
        <input id="nameInput" maxlength="12" placeholder="è¼¸å…¥æš±ç¨±ï¼ˆå¯é¸ï¼‰" />
        <button class="btn secondary" id="btnSetName">å¥—ç”¨</button>
      </div>

      <div class="hint">
        æ’è¡Œæ¦œä½¿ç”¨ LocalStorageï¼ˆå…å¾Œç«¯ï¼‰ã€‚<br/>
        å°æé†’ï¼šLINE/iOS éœ€ç¬¬ä¸€æ¬¡é»æ“Šå¾Œæ‰å…è¨±æ’­æ”¾è²éŸ³ï¼ˆå·²è™•ç†ï¼‰ã€‚
      </div>
    </div>
  </div>

  <div class="gamebox">
    <canvas id="cv" width="480" height="480"></canvas>

    <div class="controls">
      <div class="pad" id="left">â¬…ï¸</div>
      <div class="pad" id="up">â¬†ï¸</div>
      <div class="pad" id="right">â¡ï¸</div>
      <div class="pad" id="down" style="grid-column: 2 / 3;">â¬‡ï¸</div>
    </div>
  </div>

  <div class="footer">
    é£Ÿç‰©/å½©è›‹/åœ°é›·æœƒéš¨æ©Ÿç”Ÿæˆåœ¨åœ°åœ–ä¸Šï¼Œåƒåˆ°æœƒä¾è¦å‰‡åŠ æ¸›åˆ†èˆ‡å¢æ¸›èº«é«”ã€‚<br/>
    çµæŸåŠ æˆï¼šæ¯å¤šä¸€æ ¼èº«é«” +1 åˆ†ï¼ˆä»¥åˆå§‹é•·åº¦ 1 ç‚ºåŸºæº–ï¼‰ã€‚
  </div>
</div>

<!-- å…±ç”¨ Modal -->
<div class="mask" id="mask">
  <div class="modal">
    <div class="modalHead">
      <div class="modalHeadLeft">
        <img id="modalAva" class="avatar" alt="é¹¿é¹¿" />
        <div style="min-width:0;">
          <h3 id="modalTitle" style="margin:0 0 6px;">æç¤º</h3>
          <div style="font-size:12px;opacity:.8;line-height:1.35;" id="modalSub"></div>
        </div>
      </div>
      <div>
        <span class="tag">åˆ†æ•¸ <span id="modalScore">0</span></span>
      </div>
    </div>

    <p id="modalText" style="margin-top:10px;"></p>

    <div class="rank" id="rankBox" style="display:none;">
      <b>ğŸ† æ’è¡Œæ¦œï¼ˆå‰ 10 åï¼‰</b>
      <ol id="rankList"></ol>
    </div>

    <div class="actions">
      <button class="btn secondary" id="btnClose">é—œé–‰</button>
      <button class="btn secondary" id="btnClearRank" style="display:none;">æ¸…ç©ºæ’è¡Œæ¦œ</button>
      <button class="btn" id="btnGo" style="display:none;">é–‹å§‹éŠæˆ²</button>
      <button class="btn" id="btnAgain" style="display:none;">å†ç©ä¸€æ¬¡</button>
    </div>
  </div>
</div>

<script>
(() => {
  /***********************
   * 1) åœ–ç‰‡ç¶²å€ï¼ˆä½ æä¾›ï¼‰
   ***********************/
  const URLS = {
    HEAD: "https://github.com/z883662/Aruru/blob/main/lulu1.png?raw=true", // è›‡é ­ï¼šé¹¿é¹¿
    ASHUI: "https://github.com/z883662/Aruru/blob/main/lulu4.png?raw=true", // é˜¿æ°´
    DAD: "https://github.com/z883662/Aruru/blob/main/lulu2.png?raw=true",   // é¹¿çˆ¸
    MOM: "https://github.com/z883662/Aruru/blob/main/lulu3.png?raw=true",   // èŠ±åª½ï¼ˆå½©è›‹ï¼‰
    ANGRY: "https://github.com/z883662/Aruru/blob/main/lulu5.png?raw=true", // ç”Ÿæ°£é¹¿é¹¿ï¼ˆåœ°é›·ï¼‰
  };

  const LULU_POOL = [URLS.HEAD, URLS.DAD, URLS.MOM, URLS.ASHUI, URLS.ANGRY];

  function pickRandomAva(){ return LULU_POOL[Math.floor(Math.random()*LULU_POOL.length)]; }

  /***********************
   * 2) åŸºç¤è¨­å®š / UI
   ***********************/
  const STORAGE_KEY = "aruru_snake_board_v2";
  const BEST_KEY = "aruru_snake_best_v2";
  const NAME_KEY = "aruru_snake_name_v2";
  const AUDIO_KEY = "aruru_snake_audio_v2";

  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");

  const GRID = 24;
  const CELL = cv.width / GRID;

  const $playerName = document.getElementById("playerName");
  const $nameInput = document.getElementById("nameInput");
  const $score = document.getElementById("score");
  const $best = document.getElementById("best");
  const $spd = document.getElementById("spd");
  const $streak = document.getElementById("streak");
  const $mult = document.getElementById("mult");
  const $nextItem = document.getElementById("nextItem");
  const $len = document.getElementById("len");

  // Modal
  const mask = document.getElementById("mask");
  const modalAva = document.getElementById("modalAva");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const modalText = document.getElementById("modalText");
  const modalScore = document.getElementById("modalScore");
  const rankBox = document.getElementById("rankBox");
  const rankList = document.getElementById("rankList");
  const btnClose = document.getElementById("btnClose");
  const btnGo = document.getElementById("btnGo");
  const btnAgain = document.getElementById("btnAgain");
  const btnClearRank = document.getElementById("btnClearRank");

  function openModal({title, sub="", text="", score=0, showRank=false, showGo=false, showAgain=false, showClear=false, rankData=null, avaUrl=null}) {
    modalTitle.textContent = title;
    modalSub.textContent = sub;
    modalText.innerHTML = text.replace(/\n/g,"<br/>");
    modalScore.textContent = fmt(score);
    modalAva.src = avaUrl || pickRandomAva();

    rankBox.style.display = showRank ? "block" : "none";
    if (showRank) renderRank(rankData || loadBoard());

    btnGo.style.display = showGo ? "inline-flex" : "none";
    btnAgain.style.display = showAgain ? "inline-flex" : "none";
    btnClearRank.style.display = showClear ? "inline-flex" : "none";

    mask.style.display = "flex";
  }
  function closeModal(){ mask.style.display = "none"; }

  btnClose.addEventListener("click", closeModal);

  /***********************
   * 3) åœ–ç‰‡é è¼‰ï¼ˆé¿å…ç™½å¡Šï¼‰
   ***********************/
  const SPR = {};
  function loadImg(url){
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.onerror = () => resolve(null);
      img.src = url;
    });
  }

  async function preload() {
    const entries = Object.entries(URLS);
    for (const [k, url] of entries) SPR[k] = await loadImg(url);
    // pool
    for (const url of LULU_POOL) { /* warm cache */ await loadImg(url); }
  }

  /***********************
   * 4) ç©å®¶æš±ç¨±
   ***********************/
  let playerName = localStorage.getItem(NAME_KEY) || "Guest";
  $playerName.textContent = playerName;
  $nameInput.value = (playerName === "Guest") ? "" : playerName;

  document.getElementById("btnSetName").addEventListener("click", () => {
    const v = ($nameInput.value || "").trim().slice(0,12);
    playerName = v || "Guest";
    localStorage.setItem(NAME_KEY, playerName);
    $playerName.textContent = playerName;
    sfxBeep(660, 0.06, "triangle", 0.12);
  });

  /***********************
   * 5) è²éŸ³ï¼šBGM / SFX + éŸ³é‡
   ***********************/
  const $bgmOn = document.getElementById("bgmOn");
  const $sfxOn = document.getElementById("sfxOn");
  const $bgmVol = document.getElementById("bgmVol");
  const $sfxVol = document.getElementById("sfxVol");

  let audioCtx = null;
  let master = null;
  let bgmGain = null;
  let sfxGain = null;
  let bgmTimer = null;

  function loadAudioPrefs(){
    try{
      const p = JSON.parse(localStorage.getItem(AUDIO_KEY) || "{}");
      if (typeof p.bgmOn === "boolean") $bgmOn.checked = p.bgmOn;
      if (typeof p.sfxOn === "boolean") $sfxOn.checked = p.sfxOn;
      if (typeof p.bgmVol === "number") $bgmVol.value = String(p.bgmVol);
      if (typeof p.sfxVol === "number") $sfxVol.value = String(p.sfxVol);
    } catch {}
  }
  function saveAudioPrefs(){
    localStorage.setItem(AUDIO_KEY, JSON.stringify({
      bgmOn: $bgmOn.checked,
      sfxOn: $sfxOn.checked,
      bgmVol: Number($bgmVol.value),
      sfxVol: Number($sfxVol.value),
    }));
  }
  loadAudioPrefs();

  function ensureAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    master = audioCtx.createGain();
    master.gain.value = 0.9;
    master.connect(audioCtx.destination);

    bgmGain = audioCtx.createGain();
    sfxGain = audioCtx.createGain();
    bgmGain.connect(master);
    sfxGain.connect(master);
    applyVolumes();
  }

  function applyVolumes(){
    if (!bgmGain || !sfxGain) return;
    const bgm = Number($bgmVol.value) / 100; // 0..1
    const sfx = Number($sfxVol.value) / 100;
    bgmGain.gain.value = Math.max(0, Math.min(1, bgm)) * 0.28;
    sfxGain.gain.value = Math.max(0, Math.min(1, sfx)) * 0.9;
  }

  $bgmOn.addEventListener("change", () => { saveAudioPrefs(); if ($bgmOn.checked) startBGM(); else stopBGM(); });
  $sfxOn.addEventListener("change", saveAudioPrefs);
  $bgmVol.addEventListener("input", () => { applyVolumes(); saveAudioPrefs(); });
  $sfxVol.addEventListener("input", () => { applyVolumes(); saveAudioPrefs(); });

  function sfxBeep(freq, dur=0.08, type="sine", vol=0.18) {
    if (!$sfxOn.checked) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(vol, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    o.connect(g);
    g.connect(sfxGain);
    o.start(t0);
    o.stop(t0 + dur + 0.03);
  }

  function startBGM() {
    if (!$bgmOn.checked) return;
    ensureAudio();
    stopBGM();

    // Qç‰ˆè¼•éŸ³å’Œå¼¦åˆ†è§£ï¼ˆä¸åµï¼‰
    const seq = [
      [392, 494, 587], // G
      [440, 554, 659], // A
      [349, 440, 523], // F
      [392, 494, 587], // G
    ];
    let step = 0;

    bgmTimer = setInterval(() => {
      if (!$bgmOn.checked || !audioCtx) return;
      const chord = seq[step % seq.length]; step++;

      chord.forEach((f, i) => {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "triangle";
        o.frequency.value = f * (i === 0 ? 0.5 : 1);
        o.connect(g);
        g.connect(bgmGain);

        const t = audioCtx.currentTime + i * 0.02;
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.22, t + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);

        o.start(t);
        o.stop(t + 0.22);
      });
    }, 520);
  }
  function stopBGM(){ if (bgmTimer) clearInterval(bgmTimer); bgmTimer = null; }

  // iOS/LINEï¼šç¬¬ä¸€æ¬¡äº’å‹•å¾Œè§£é–éŸ³è¨Š
  function unlockAudio() {
    ensureAudio();
    if (audioCtx.state === "suspended") audioCtx.resume();
    if ($bgmOn.checked) startBGM();
    window.removeEventListener("pointerdown", unlockAudio);
    window.removeEventListener("touchstart", unlockAudio);
    window.removeEventListener("keydown", unlockAudio);
  }
  window.addEventListener("pointerdown", unlockAudio, {once:false});
  window.addEventListener("touchstart", unlockAudio, {once:false});
  window.addEventListener("keydown", unlockAudio, {once:false});

  /***********************
   * 6) æ’è¡Œæ¦œï¼ˆLocalStorageï¼‰+ éš¨æ©Ÿé¹¿é¹¿åœ–
   ***********************/
  function loadBoard(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch { return []; }
  }
  function saveBoard(list){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }
  function addScoreToBoard(entry){
    const list = loadBoard();
    list.push(entry);
    list.sort((a,b) => b.score - a.score);
    const top10 = list.slice(0,10);
    saveBoard(top10);
    return top10;
  }
  function clearBoard(){ localStorage.removeItem(STORAGE_KEY); }

  function renderRank(list){
    const data = Array.isArray(list) ? list : loadBoard();
    rankList.innerHTML = "";
    data.slice(0,10).forEach((r, i) => {
      const li = document.createElement("li");
      const left = document.createElement("div");
      left.className = "rankLeft";
      const ava = document.createElement("img");
      ava.className = "rankAva";
      ava.src = r.avaUrl || pickRandomAva();
      ava.alt = "é¹¿é¹¿";
      const name = document.createElement("div");
      name.className = "rankName";
      name.textContent = `${i+1}. ${r.name || "ç©å®¶"}`;
      left.appendChild(ava);
      left.appendChild(name);

      const sc = document.createElement("div");
      sc.className = "rankScore";
      sc.textContent = fmt(r.score ?? 0);

      li.appendChild(left);
      li.appendChild(sc);
      rankList.appendChild(li);
    });
  }

  btnClearRank.addEventListener("click", () => {
    clearBoard();
    renderRank([]);
    sfxBeep(330, 0.08, "square", 0.18);
  });

  document.getElementById("btnRank").addEventListener("click", () => {
    openModal({
      title: "æ’è¡Œæ¦œ",
      sub: "éš¨æ©Ÿé¹¿é¹¿é ­è²¼ï¼‹å‰ 10 å",
      text: "ï¼ˆæœ¬æ’è¡Œæ¦œå„²å­˜åœ¨ä½ çš„è£ç½® LocalStorageï¼‰",
      score: currentScoreFinalForUI(),
      showRank: true,
      showClear: true,
      avaUrl: pickRandomAva()
    });
  });

  /***********************
   * 7) éŠæˆ²ç‰©ä»¶èˆ‡è¦å‰‡ï¼ˆä½ æŒ‡å®šï¼‰
   ***********************/
  const ITEM_DEFS = [
    { key:"ASHUI", name:"é˜¿æ°´",   prob:0.35, score:+1,   grow:+1,   isPositive:true },
    { key:"DAD",   name:"é¹¿çˆ¸",   prob:0.25, score:+1.5, grow:+1.5, isPositive:true },
    { key:"MOM",   name:"èŠ±åª½",   prob:0.20, score:+3,   grow:+2,   isPositive:true, isEgg:true },
    { key:"ANGRY", name:"ç”Ÿæ°£é¹¿é¹¿",prob:0.20, score:-3,  shrink:2,  isPositive:false, isMine:true },
  ];

  function pickItemByProb(){
    const r = Math.random();
    let acc = 0;
    for (const it of ITEM_DEFS){
      acc += it.prob;
      if (r <= acc) return it;
    }
    return ITEM_DEFS[0];
  }

  /***********************
   * 8) éŠæˆ²ç‹€æ…‹
   ***********************/
  let running = false;

  let dir = {x:1,y:0};
  let nextDir = {x:1,y:0};

  let snake = [];                 // ä»¥ cell åº§æ¨™
  const INIT_LEN = 1;

  let target = null;              // ç›®å‰åœ°åœ–ä¸Šçš„å–®ä¸€ç‰©ä»¶ï¼š{x,y,def}
  let nextDef = pickItemByProb(); // é¡¯ç¤ºä¸‹ä¸€éš»ï¼ˆæç¤ºï¼‰
  $nextItem.textContent = nextDef.name;

  let baseTickMs = 120;           // åˆå§‹é€Ÿåº¦
  let tickMs = baseTickMs;
  let tickHandle = null;

  let pendingGrowth = 0;          // æ”¯æ´ 1.5
  let score = 0;                  // éŠæˆ²å…§å³æ™‚åˆ†æ•¸ï¼ˆå°šæœªåŠ çµæŸé•·åº¦åŠ æˆï¼‰
  let best = Number(localStorage.getItem(BEST_KEY) || 0);

  // streak
  let streak = 0;
  let lastPositiveEatAt = 0;

  // èŠ±åª½åŠ é€Ÿ
  const MOM_SPEED_FACTOR = 1.7;   // ä½ æŒ‡å®šï¼š1.7 å€
  const MOM_SPEED_MS = baseTickMs / MOM_SPEED_FACTOR; // ç´„ 70.6ms
  const MOM_BOOST_MS = 3000;      // ä½ æŒ‡å®šï¼š3 ç§’
  let momBoostUntil = 0;

  $best.textContent = fmt(best);

  function fmt(n){
    const x = Number(n) || 0;
    // é¡¯ç¤º 0.5ã€1.5 é€™ç¨®ï¼šæœ€å¤š 2 ä½å°æ•¸ï¼Œå»å°¾é›¶
    return x.toFixed(2).replace(/\.?0+$/,"");
  }

  function multiplierLevel(){
    // 10/20/30... -> 1/2/3...
    return Math.floor(streak / 10);
  }

  function scoreMultiplier(){
    // x1.25, x1.5, x1.75 ...
    const lv = multiplierLevel();
    return 1 + lv * 0.25;
  }

  function speedFactorFromStreak(){
    // é€£åƒå¾®å¹…åŠ å¿«ï¼šæ¯ streak +1%ï¼ˆä¸Šé™ 20%ï¼‰ï¼Œåƒ…åƒåˆ°åŠ åˆ†é …ç›®æ‰æœƒç¶­æŒ
    const micro = 1 + Math.min(0.20, streak * 0.01);

    // 10/20/30... é€Ÿåº¦é–‹å§‹å¢åŠ ï¼š+20% / +30% / +40%...
    const lv = multiplierLevel();
    const tier = (lv >= 1) ? (1 + (0.10 * lv + 0.10)) : 1; // lv1=1.2, lv2=1.3, lv3=1.4...

    return micro * tier;
  }

  function effectiveTickMs(){
    // åŸºæ–¼ streak çš„åŸºç¤é€Ÿåº¦
    const sf = speedFactorFromStreak();
    let ms = baseTickMs / sf;

    // èŠ±åª½åŠ é€Ÿè¦†è“‹ï¼ˆæ›´å¿«ï¼‰
    if (Date.now() < momBoostUntil) ms = Math.min(ms, MOM_SPEED_MS);

    // å¤¾é™
    ms = Math.max(55, Math.min(180, ms));
    return ms;
  }

  function applyTickRate(){
    const newMs = effectiveTickMs();
    if (Math.abs(newMs - tickMs) < 0.5) return;
    tickMs = newMs;
    if (running){
      clearInterval(tickHandle);
      tickHandle = setInterval(tick, tickMs);
    }
  }

  function updateUI(){
    $score.textContent = fmt(score);
    $streak.textContent = String(Math.floor(streak));
    $mult.textContent = "x" + fmt(scoreMultiplier());
    $len.textContent = String(snake.length);

    const boosting = Date.now() < momBoostUntil;
    const sf = speedFactorFromStreak();
    const baseFast = (sf > 1.02);

    if (boosting) $spd.textContent = "èŠ±åª½åŠ é€Ÿä¸­";
    else if (baseFast) $spd.textContent = "é€£åƒåŠ é€Ÿä¸­";
    else $spd.textContent = "æ­£å¸¸";
  }

  function cellOccupied(c){
    if (snake.some(s => s.x===c.x && s.y===c.y)) return true;
    if (target && target.x===c.x && target.y===c.y) return true;
    return false;
  }

  function randCell(){
    return { x: Math.floor(Math.random()*GRID), y: Math.floor(Math.random()*GRID) };
  }

  function spawnTarget(){
    const def = nextDef;
    nextDef = pickItemByProb();
    $nextItem.textContent = nextDef.name;

    let c = randCell();
    let tries = 0;
    while (cellOccupied(c) && tries < 500) { c = randCell(); tries++; }

    target = { x:c.x, y:c.y, def };
  }

  function resetGame(){
    running = false;
    clearInterval(tickHandle); tickHandle = null;

    dir = {x:1,y:0};
    nextDir = {x:1,y:0};

    snake = [{ x: Math.floor(GRID/2), y: Math.floor(GRID/2) }];
    pendingGrowth = 0;

    score = 0;
    streak = 0;
    lastPositiveEatAt = 0;
    momBoostUntil = 0;

    target = null;
    spawnTarget();

    applyTickRate();
    updateUI();
    draw();
  }

  function startGame(){
    if (running) return;
    running = true;

    ensureAudio();
    if (audioCtx.state === "suspended") audioCtx.resume();
    if ($bgmOn.checked) startBGM();

    applyTickRate();
    clearInterval(tickHandle);
    tickHandle = setInterval(tick, tickMs);
  }

  function setDir(nx, ny){
    // ç¦æ­¢åå‘
    if (snake.length > 1 && nx === -dir.x && ny === -dir.y) return;
    nextDir = {x:nx, y:ny};
  }

  function currentScoreFinalForUI(){
    // ä½ æŒ‡å®šï¼šçµæŸæ™‚ã€Œæ¯å¤šä¸€æ ¼èº«é«” +1 åˆ†ã€
    const bonus = Math.max(0, snake.length - INIT_LEN);
    return score + bonus;
  }

  function gameOver(reason="æ’åˆ°ç‰†æˆ–è‡ªå·±"){
    running = false;
    clearInterval(tickHandle); tickHandle = null;

    // å¤±æ•—éŸ³æ•ˆ
    sfxBeep(220, 0.10, "sawtooth", 0.22);
    sfxBeep(196, 0.12, "sawtooth", 0.18);

    const bonus = Math.max(0, snake.length - INIT_LEN);
    const finalScore = score + bonus;

    if (finalScore > best){
      best = finalScore;
      localStorage.setItem(BEST_KEY, String(best));
      $best.textContent = fmt(best);
    }

    // æ’è¡Œæ¦œç´€éŒ„é™„éš¨æ©Ÿé¹¿é¹¿é ­è²¼
    const avaUrl = pickRandomAva();
    const top10 = addScoreToBoard({ name: playerName, score: finalScore, at: Date.now(), avaUrl });

    openModal({
      title: `éŠæˆ²çµæŸï¼`,
      sub: `åŸå› ï¼š${reason}ã€€ï½œã€€çµæŸåŠ æˆï¼šèº«é«”å¤š ${bonus} æ ¼ +${bonus} åˆ†`,
      text:
`ä½ çš„æœ€çµ‚åˆ†æ•¸ï¼š<b>${fmt(finalScore)}</b><br/>
ï¼ˆå³æ™‚åˆ†æ•¸ï¼š${fmt(score)}  ï¼‹  é•·åº¦åŠ æˆï¼š${fmt(bonus)}ï¼‰`,
      score: finalScore,
      showRank: true,
      showAgain: true,
      rankData: top10,
      avaUrl
    });
    btnAgain.style.display = "inline-flex";
  }

  btnAgain.addEventListener("click", () => {
    closeModal();
    resetGame();
    startGame();
  });

  btnGo.addEventListener("click", () => {
    closeModal();
    resetGame();
    startGame();
  });

  /***********************
   * 9) åƒåˆ°ç‰©ä»¶çš„è™•ç†ï¼ˆåŠ åˆ†/æ‰£åˆ†/å¢æ¸›èº«é«”/åŠ é€Ÿï¼‰
   ***********************/
  function onEat(def){
    if (def.isPositive){
      // streak +1
      streak += 1;
      lastPositiveEatAt = Date.now();

      // å€ç‡åˆ†æ•¸ï¼ˆåªå°åŠ åˆ†é …ç›®ï¼‰
      const mult = scoreMultiplier();
      const add = (def.score || 0) * mult;
      score += add;

      // å¢é•·ï¼ˆæ”¯æ´ 1.5ï¼‰
      pendingGrowth += (def.grow || 0);

      // éŸ³æ•ˆï¼šé€£åƒéŸ³é«˜è®Šé«˜
      const pitch = 520 + Math.min(30, Math.floor(streak)) * 18;
      sfxBeep(pitch, 0.06, "sine", 0.18);
      sfxBeep(pitch * 1.18, 0.04, "triangle", 0.12);

      // èŠ±åª½ï¼šçŸ­æš«åŠ é€Ÿ 3 ç§’ï¼ˆ1.7 å€ï¼‰ï¼‹æ˜é¡¯ç‰¹æ®ŠéŸ³æ•ˆ
      if (def.isEgg){
        momBoostUntil = Date.now() + MOM_BOOST_MS;
        sfxBeep(988, 0.07, "square", 0.20);
        sfxBeep(1319, 0.09, "square", 0.18);
        sfxBeep(1760, 0.11, "triangle", 0.14);
      }
    } else {
      // æ‰£åˆ†é …ç›®ï¼šä¸­æ–·é€£åƒï¼‹é€Ÿåº¦é‡ç½®å¾åˆå§‹è¨ˆç®—
      streak = 0;
      lastPositiveEatAt = 0;
      momBoostUntil = 0; // åœ°é›·ä¹ŸæŠŠèŠ±åª½åŠ é€Ÿæ‰“æ‰ï¼ˆæ›´ç›´è¦ºï¼‰

      score += (def.score || 0); // negative
      // ä¸èƒ½ä½æ–¼ 0 åˆ†ï¼Ÿä½ æ²’è¦æ±‚ï¼Œæ‰€ä»¥å…è¨±è² åˆ†ï¼ˆæƒ³é– 0 æˆ‘ä¹Ÿå¯æ”¹ï¼‰

      // èº«é«”æ¸›å°‘ï¼šæ¯åƒ 1 å€‹æ¸›å°‘ 2 å€‹éƒ¨åˆ†ï¼Œæœ€ä½ç‚ºåˆå§‹ 1
      const shrink = def.shrink || 0;
      if (shrink > 0){
        // å…ˆæ¸…æ‰ pendingGrowthï¼Œé¿å…ã€Œå‰›åŠ é•·åˆç¸®çŸ­ã€çš„å¥‡æ€ªåŠæ®µ
        pendingGrowth = 0;
        for (let i=0; i<shrink; i++){
          if (snake.length > INIT_LEN) snake.pop();
        }
      }

      // æ˜é¡¯åœ°é›·éŸ³æ•ˆ
      sfxBeep(160, 0.09, "sawtooth", 0.22);
      sfxBeep(120, 0.11, "sawtooth", 0.20);
    }

    applyTickRate();
    updateUI();
  }

  /***********************
   * 10) Tickï¼šç§»å‹•ã€ç¢°æ’ã€åƒåˆ°ã€é€£åƒè¡°æ¸›
   ***********************/
  function tick(){
    if (!running) return;

    // é€£åƒè¡°æ¸›ï¼šè¶…é 3 ç§’æ²’åƒåˆ°åŠ åˆ†é …ç›®æ‰é–‹å§‹ä¸‹é™
    if (streak > 0 && lastPositiveEatAt > 0) {
      if (Date.now() - lastPositiveEatAt >= 3000) {
        streak = Math.max(0, streak - 0.35);
      }
    }

    dir = nextDir;
    const head = snake[0];
    const newHead = { x: head.x + dir.x, y: head.y + dir.y };

    // æ’ç‰†
    if (newHead.x < 0 || newHead.y < 0 || newHead.x >= GRID || newHead.y >= GRID){
      gameOver("æ’åˆ°ç‰†");
      return;
    }

    // æ’è‡ªå·±
    if (snake.some((s,i)=> i!==0 && s.x===newHead.x && s.y===newHead.y)){
      gameOver("æ’åˆ°è‡ªå·±");
      return;
    }

    snake.unshift(newHead);

    // åƒåˆ°ç‰©ä»¶
    if (target && newHead.x === target.x && newHead.y === target.y){
      onEat(target.def);
      target = null;
      spawnTarget();
    }

    // å¢é•·/ç¶­æŒé•·åº¦ï¼špendingGrowth >= 1 å°±ä¸ pop
    if (pendingGrowth >= 1){
      pendingGrowth -= 1;
      // ä¸ pop -> èº«é«”è®Šé•·
    } else {
      // æ­£å¸¸å‰é€² -> ç§»é™¤å°¾å·´
      if (snake.length > INIT_LEN) snake.pop();
      else snake.pop(); // INIT_LEN=1 ä»è¦è®“é ­å‰é€²ï¼›ä½†å› ç‚º unshift äº†ï¼Œpop è®“é•·åº¦ç¶­æŒ 1
    }

    applyTickRate();
    updateUI();
    draw();
  }

  /***********************
   * 11) ç¹ªåœ–ï¼šæ ¼ç·š + è›‡èº« + è›‡é ­(åœ–ç‰‡) + ç‰©ä»¶(åœ–ç‰‡)
   ***********************/
  function drawGridGlow(){
    ctx.save();
    ctx.globalAlpha = 0.08;
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 1;
    for(let i=1;i<GRID;i++){
      ctx.beginPath(); ctx.moveTo(i*CELL,0); ctx.lineTo(i*CELL,cv.height); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0,i*CELL); ctx.lineTo(cv.width,i*CELL); ctx.stroke();
    }
    ctx.restore();
  }

  function roundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  function drawBody(seg, idx){
    const x = seg.x * CELL, y = seg.y * CELL;
    ctx.save();
    ctx.fillStyle = (idx % 2 === 0) ? "#ffd98a" : "#ffe29a";
    roundRect(x+2,y+2,CELL-4,CELL-4,8);
    ctx.fill();

    // æ–‘é»ï¼ˆæ˜é¡¯ï¼‰
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = "#d0892d";
    [[x+6,y+7],[x+12,y+10],[x+9,y+14]].forEach(([sx,sy])=>{
      ctx.beginPath();
      ctx.ellipse(sx, sy, 2.7, 2.2, 0, 0, Math.PI*2);
      ctx.fill();
    });
    ctx.restore();
  }

  function drawHead(seg){
    const img = SPR.HEAD;
    const x = seg.x * CELL, y = seg.y * CELL;

    // å…ˆç•«åº•ï¼ˆé¿å…åœ–ç‰‡é€æ˜é€ æˆç ´æ´ï¼‰
    ctx.save();
    ctx.fillStyle = "#ffe29a";
    roundRect(x+2,y+2,CELL-4,CELL-4,8);
    ctx.fill();
    ctx.restore();

    if (!img){
      // fallbackï¼šæ²’è¼‰å…¥åˆ°å°±ç”¨ç°¡åŒ–é ­
      ctx.save();
      ctx.fillStyle="#111";
      ctx.beginPath(); ctx.arc(x+14,y+10,2.2,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(x+18,y+13,2.2,0,Math.PI*2); ctx.fill();
      ctx.restore();
      return;
    }

    // ä¾æ–¹å‘æ—‹è½‰åœ–ç‰‡
    let ang = 0;
    if (dir.x === 1) ang = 0;
    if (dir.x === -1) ang = Math.PI;
    if (dir.y === 1) ang = Math.PI/2;
    if (dir.y === -1) ang = -Math.PI/2;

    const cx = x + CELL/2;
    const cy = y + CELL/2;
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(ang);
    const size = CELL * 0.92;
    ctx.drawImage(img, -size/2, -size/2, size, size);
    ctx.restore();
  }

  function drawTarget(t){
    if (!t) return;
    const def = t.def;
    const img = SPR[def.key] || null;
    const x = t.x * CELL, y = t.y * CELL;

    ctx.save();

    // å¤–å…‰ï¼ˆè®“å½©è›‹/åœ°é›·æ›´æ˜é¡¯ï¼‰
    if (def.isEgg){
      ctx.shadowColor = "rgba(255,200,0,.5)";
      ctx.shadowBlur = 16;
    } else if (def.isMine){
      ctx.shadowColor = "rgba(255,60,60,.5)";
      ctx.shadowBlur = 16;
    } else {
      ctx.shadowColor = "rgba(255,120,190,.35)";
      ctx.shadowBlur = 10;
    }

    if (img){
      const pad = CELL * 0.08;
      ctx.drawImage(img, x+pad, y+pad, CELL-2*pad, CELL-2*pad);
    } else {
      // fallbackï¼šç”¨çƒ
      ctx.fillStyle = def.isMine ? "#ff4d4f" : (def.isEgg ? "#ffd24d" : "#ff5aa5");
      ctx.beginPath();
      ctx.arc(x+CELL/2, y+CELL/2, CELL*0.34, 0, Math.PI*2);
      ctx.fill();
    }

    ctx.restore();
  }

  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.fillStyle = "#0b0b0f";
    ctx.fillRect(0,0,cv.width,cv.height);

    drawGridGlow();

    // target
    drawTarget(target);

    // body then head
    for (let i=snake.length-1; i>=1; i--) drawBody(snake[i], i);
    drawHead(snake[0]);

    if (!running){
      ctx.save();
      ctx.globalAlpha = 0.92;
      ctx.fillStyle = "rgba(255,255,255,.85)";
      ctx.font = "bold 18px system-ui, -apple-system";
      ctx.textAlign = "center";
      ctx.fillText("æŒ‰ã€Œé–‹å§‹ã€æˆ–æ»‘å‹•/æ–¹å‘éµé–‹å§‹", cv.width/2, cv.height/2 - 10);
      ctx.font = "13px system-ui, -apple-system";
      ctx.fillStyle = "rgba(255,255,255,.7)";
      ctx.fillText("é˜¿æ°´/é¹¿çˆ¸/èŠ±åª½åŠ åˆ†ï¼Œç”Ÿæ°£é¹¿é¹¿æ‰£åˆ†ç¸®çŸ­", cv.width/2, cv.height/2 + 14);
      ctx.restore();
    }
  }

  /***********************
   * 12) è¼¸å…¥ï¼šéµç›¤ / è§¸æ§æ»‘å‹• / æŒ‰éˆ•
   ***********************/
  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowUp") setDir(0,-1);
    if (e.key === "ArrowDown") setDir(0,1);
    if (e.key === "ArrowLeft") setDir(-1,0);
    if (e.key === "ArrowRight") setDir(1,0);
    if (!running && ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) startGame();
  });

  function bindPad(id, nx, ny){
    const el = document.getElementById(id);
    el.addEventListener("pointerdown", (ev) => {
      ev.preventDefault();
      setDir(nx, ny);
      if (!running) startGame();
    });
  }
  bindPad("up", 0, -1);
  bindPad("down", 0, 1);
  bindPad("left", -1, 0);
  bindPad("right", 1, 0);

  let sx=0, sy=0, st=0;
  cv.addEventListener("touchstart", (e) => {
    const t = e.touches[0];
    sx = t.clientX; sy = t.clientY; st = Date.now();
  }, {passive:true});

  cv.addEventListener("touchend", (e) => {
    const t = e.changedTouches[0];
    const dxT = t.clientX - sx;
    const dyT = t.clientY - sy;
    const dt = Date.now() - st;
    if (dt > 500) return;
    if (Math.abs(dxT) < 18 && Math.abs(dyT) < 18) return;

    if (Math.abs(dxT) > Math.abs(dyT)) setDir(dxT > 0 ? 1 : -1, 0);
    else setDir(0, dyT > 0 ? 1 : -1);

    if (!running) startGame();
  });

  /***********************
   * 13) æŒ‰éˆ•ï¼šé–‹å§‹ / ç©æ³•
   ***********************/
  document.getElementById("btnStart").addEventListener("click", () => {
    if (!snake.length) resetGame();
    startGame();
  });

  document.getElementById("btnHow").addEventListener("click", () => {
    const rule =
`ã€å‡ºç¾æ©Ÿç‡ / åˆ†æ•¸ / èº«é«”è®ŠåŒ–ã€‘
â€¢ é˜¿æ°´ 35%ï¼š+1 åˆ†ï¼Œèº«é«” +1
â€¢ é¹¿çˆ¸ 25%ï¼š+1.5 åˆ†ï¼Œèº«é«” +1.5
â€¢ èŠ±åª½ 20%ï¼ˆå½©è›‹ï¼‰ï¼š+3 åˆ†ï¼Œèº«é«” +2ï¼Œé€Ÿåº¦ 1.7 å€åŠ é€Ÿ 3 ç§’ï¼ˆç‰¹æ®ŠéŸ³æ•ˆï¼‰
â€¢ ç”Ÿæ°£é¹¿é¹¿ 20%ï¼ˆåœ°é›·ï¼‰ï¼š-3 åˆ†ï¼Œèº«é«” -2ï¼ˆæœ€ä½ä¸å°æ–¼åˆå§‹é•·åº¦ 1ï¼‰ï¼Œä¸¦ä¸­æ–·é€£åƒã€é€Ÿåº¦é‡ç½®

ã€é€£åƒ streakã€‘
1) åªè¦åƒåˆ°ã€ŒåŠ åˆ†é …ç›®ã€å°± streak +1ï¼›åƒåˆ°æ‰£åˆ†é …ç›® = ä¸­æ–·ï¼ˆæ­¸ 0ï¼‰
2) é€£çºŒåƒåˆ°åŠ åˆ†é …ç›®æ‰æœƒæŒçºŒå¾®å¹…åŠ é€Ÿ + éŸ³æ•ˆéŸ³é«˜ä¸Šå‡
3) è¶…é 3 ç§’æ²’åƒåˆ°åŠ åˆ†é …ç›®ï¼Œstreak æœƒç·©æ…¢ä¸‹é™ï¼ˆæ¯ tick ç´„ -0.35ï¼‰
4) streak é” 10/20/30...ï¼š
   â€¢ å€ç‡ x1.25 / x1.5 / x1.75 ...ï¼ˆåªä¹˜åœ¨ã€ŒåŠ åˆ†é …ç›®ã€å¾—åˆ†ï¼‰
   â€¢ é€Ÿåº¦é¡å¤– +20% / +30% / +40% ...

ã€çµæŸåŠ æˆã€‘
æ¯å¤šä¸€æ ¼èº«é«” +1 åˆ†ï¼ˆä»¥åˆå§‹é•·åº¦ 1 ç‚ºåŸºæº–ï¼‰`;

    openModal({
      title: "ç©æ³•èˆ‡åŠ æ¸›åˆ†èªªæ˜",
      sub: "åƒé¹¿ç²‰ï¼ˆè§’è‰²ï¼‰æˆé•·ï¼é¿é–‹åœ°é›·ï¼",
      text: rule,
      score: currentScoreFinalForUI(),
      showRank: false,
      showClear: false,
      avaUrl: pickRandomAva()
    });
  });

  /***********************
   * 14) é–‹å§‹å‰é®ç½©ï¼ˆä½ è¦æ±‚ï¼‰
   ***********************/
  function showStartIntro(){
    openModal({
      title: "æº–å‚™é–‹å§‹ï¼",
      sub: "é˜¿é¹¿é¹¿æ–‡å‰µ-è²ªé£Ÿé¹¿(åƒé¹¿ç²‰)",
      text:
`æ»‘å‹•æˆ–æ–¹å‘éµæ§åˆ¶é¹¿é¹¿ç§»å‹•ã€‚<br/>
åœ°åœ–æœƒéš¨æ©Ÿå‡ºç¾ã€Œé˜¿æ°´/é¹¿çˆ¸/èŠ±åª½/ç”Ÿæ°£é¹¿é¹¿ã€ã€‚<br/>
åƒåˆ°åŠ åˆ†é …ç›®æœƒé€£åƒåŠ é€Ÿã€é€£åƒé” 10/20/30... æœƒæœ‰å€ç‡èˆ‡é¡å¤–é€Ÿåº¦ã€‚<br/>
å°æé†’ï¼šèŠ±åª½æ˜¯å½©è›‹ï¼ˆ+3 åˆ†ã€èº«é«” +2ã€1.7 å€åŠ é€Ÿ 3 ç§’ï¼‰ã€‚<br/>
åƒåˆ°ç”Ÿæ°£é¹¿é¹¿æœƒæ‰£åˆ†ä¸¦ç¸®çŸ­ï¼ˆæœ€ä½ä¸å°æ–¼ 1ï¼‰ã€‚`,
      score: 0,
      showGo: true,
      showRank: false,
      showClear: false,
      avaUrl: pickRandomAva()
    });
  }

  /***********************
   * 15) åˆå§‹åŒ–
   ***********************/
  preload().finally(() => {
    resetGame();
    draw();
    showStartIntro();
  });

})();
</script>
</body>
</html>
